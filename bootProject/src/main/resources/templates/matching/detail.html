<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>매칭방 상세</title>
    <style>
        table {
            width: 80%;
            border-collapse: collapse;
            margin: 20px auto;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #f2f2f2;
        }
        .button {
            padding: 5px 10px;
            margin: 2px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .accept-btn {
            background-color: #4CAF50;
            color: white;
        }
        .reject-btn {
            background-color: #f44336;
            color: white;
        }
        .apply-btn {
            background-color: #008CBA;
            color: white;
        }
    </style>
    <!-- 카카오맵 API 추가 -->
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=YOUR_KAKAO_MAP_API_KEY&libraries=services"></script>
</head>
<body>
<h1 style="text-align:center;">매칭방 상세</h1>

<p style="text-align:center;">
    <a th:href="@{/matching/list}">[ 매칭방 목록으로 돌아가기 ]</a>
</p>

<table>
    <thead>
    <tr>
        <th>방번호</th>
        <th>제목</th>
        <th>장소</th>
        <th>날짜</th>
        <th>시간</th>
        <th>참가현황</th>
        <th>방장</th>
    </tr>
    </thead>
    <tbody>
    <tr>
        <td th:text="${room.roomId}">1</td>
        <td th:text="${room.title}">제목</td>
        <td th:text="${room.place}">장소</td>
        <td th:text="${room.meetingDate}">날짜</td>
        <td th:text="${room.meetingTime}">시간</td>
        <td>
            <span th:text="${room.currentParticipants}">0</span> /
            <span th:text="${room.maxParticipants}">0</span>
        </td>
        <td th:text="${room.hostPet.user.name}">방장</td>
    </tr>
    </tbody>
</table>

<!-- 방장인 경우: 참가 신청 목록 관리 -->
<div th:if="${isHost}">
    <h2 style="text-align:center;">참가 신청 목록</h2>

    <!-- 승인 대기 중인 참가자 -->
    <h3 style="text-align:center;">승인 대기 중</h3>
    <table>
        <thead>
        <tr>
            <th>사용자 이름</th>
            <th>펫 이름</th>
            <th>신청 시간</th>
            <th>상태</th>
            <th>조치</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="participant : ${pendingParticipants}">
            <td th:text="${participant.user.name}">사용자 이름</td>
            <td th:text="${participant.pet.name}">펫 이름</td>
            <td th:text="${#dates.format(participant.createdAt, 'yyyy-MM-dd HH:mm')}">신청 시간</td>
            <td th:text="${participant.status}">상태</td>
            <td>
                <form th:action="@{/matching/accept/{roomId}/{userId}/{petId}(roomId=${room.roomId}, userId=${participant.user.userId}, petId=${participant.pet.petId})}" method="post" style="display:inline;">
                    <!-- CSRF 토큰 추가 -->
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                    <button type="submit" class="button accept-btn">승인</button>
                </form>
                <form th:action="@{/matching/reject/{roomId}/{userId}/{petId}(roomId=${room.roomId}, userId=${participant.user.userId}, petId=${participant.pet.petId})}" method="post" style="display:inline;">
                    <!-- CSRF 토큰 추가 -->
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                    <button type="submit" class="button reject-btn">거절</button>
                </form>
            </td>
        </tr>
        <tr th:if="${#lists.isEmpty(pendingParticipants)}">
            <td colspan="5">승인 대기 중인 참가자가 없습니다.</td>
        </tr>
        </tbody>
    </table>

    <!-- 승인된 참가자 목록 -->
    <h3 style="text-align:center;">승인된 참가자</h3>
    <table>
        <thead>
        <tr>
            <th>사용자 이름</th>
            <th>펫 이름</th>
            <th>참가 시간</th>
            <th>상태</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="participant : ${acceptedParticipants}">
            <td th:text="${participant.user.name}">사용자 이름</td>
            <td th:text="${participant.pet.name}">펫 이름</td>
            <td th:text="${#dates.format(participant.createdAt, 'yyyy-MM-dd HH:mm')}">참가 시간</td>
            <td th:text="${participant.status}">상태</td>
        </tr>
        <tr th:if="${#lists.isEmpty(acceptedParticipants)}">
            <td colspan="4">승인된 참가자가 없습니다.</td>
        </tr>
        </tbody>
    </table>
</div>

<!-- 일반 유저인 경우: 참가자 목록 및 참가 신청 -->
<div th:if="${!isHost}">
    <h2 style="text-align:center;">참가자 목록</h2>
    <table>
        <thead>
        <tr>
            <th>사용자 이름</th>
            <th>펫 이름</th>
            <th>참가 시간</th>
            <th>상태</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="participant : ${acceptedParticipants}">
            <td th:text="${participant.user.name}">사용자 이름</td>
            <td th:text="${participant.pet.name}">펫 이름</td>
            <td th:text="${#dates.format(participant.createdAt, 'yyyy-MM-dd HH:mm')}">참가 시간</td>
            <td th:text="${participant.status}">상태</td>
        </tr>
        <tr th:if="${#lists.isEmpty(acceptedParticipants)}">
            <td colspan="4">참가자가 없습니다.</td>
        </tr>
        </tbody>
    </table>

    <!-- 참가 신청 섹션 -->
    <h2 style="text-align:center;">참가 신청</h2>
    <form th:action="@{/matching/apply/{roomId}(roomId=${room.roomId})}" method="post" style="text-align:center;">
        <!-- CSRF 토큰 추가 -->
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

        <label for="additionalPetIds">반려동물 선택:</label>
        <select name="additionalPetIds" id="additionalPetIds" multiple required>
            <option th:each="pet : ${userPets}" th:value="${pet.petId}" th:text="${pet.name}"></option>
        </select><br/><br/>
        <button type="submit" class="button apply-btn">참가 신청</button>
    </form>
</div>

<!-- 오류 메시지 표시 -->
<div th:if="${errorMessage}" style="text-align:center; color: red;">
    <p th:text="${errorMessage}"></p>
</div>

<!-- 카카오맵을 표시할 컨테이너 -->
<div class="map-placeholder" style="width:500px;height:400px;margin:20px auto;"></div>

<!-- 상세 페이지 전용 JavaScript 파일 로드 -->
<script th:src="@{/js/detail.js}"></script>
</body>
</html>
